name: Release

on:
  push:
    tags:
      - 'v*'   # e.g. v1.2.3

permissions:
  contents: write  # needed to create/update GitHub Releases

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Set version from tag (versions-maven-plugin)
        run: |
          VERSION="${GITHUB_REF_NAME#v}"  # strip leading 'v'
          echo "Using version: $VERSION"
          ./mvnw -B -ntp versions:set \
            -DnewVersion="$VERSION" \
            -DprocessAllModules=true \
            -DgenerateBackupPoms=false

      - name: Build
        run: ./mvnw -B -ntp package

      - name: Generate SHA-256 checksums (optional)
        run: |
          shopt -s globstar
          for f in **/target/*.jar; do
            sha256sum "$f" > "$f.sha256"
          done

      - name: Create GitHub Release & upload JARs
        uses: softprops/action-gh-release@v2
        with:
          files: |
            **/target/*.jar
            **/target/*.jar.sha256
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B -ntp -DskipTests deploy
