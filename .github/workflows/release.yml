name: Release

on:
  push:
    tags:
      - 'v*'   # e.g. v1.2.3

permissions:
  contents: write  # needed to create/update GitHub Releases
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Set version from tag (versions-maven-plugin)
        run: |
          VERSION="${GITHUB_REF_NAME#v}"  # strip leading 'v'
          echo "Using version: $VERSION"
          ./mvnw -B -ntp versions:set \
            -DnewVersion="$VERSION" \
            -DprocessAllModules=true \
            -DgenerateBackupPoms=false

      - name: Compute integer Getdown version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"  # e.g. 1.99.7
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # default if parts are missing (e.g. "1" or "1.2")
          : "${MINOR:=0}"
          : "${PATCH:=0}"
          
          GETDOWN_VERSION=$(( MAJOR * 1000000 + MINOR * 1000 + PATCH ))
          
          echo "SemVer: $VERSION"
          echo "Getdown integer version: $GETDOWN_VERSION"
          echo "GETDOWN_VERSION=$GETDOWN_VERSION" >> "$GITHUB_ENV"

      - name: Build
        run: ./mvnw -B -ntp package -Dgetdown.version=$GETDOWN_VERSION


      - name: Generate SHA-256 checksums (optional)
        run: |
          shopt -s globstar
          for f in **/target/*.jar; do
            sha256sum "$f" > "$f.sha256"
          done

      - name: Create GitHub Release & upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            **/target/efa*.zip
            **/target/efa*.tar
            **/target/efa*.jar
            **/target/efa*.jar.sha256
            **/target/update-site/efa.jar
            **/target/update-site/getdown.txt
            **/target/update-site/digest.txt
            **/target/update-site/digest2.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B -ntp -DskipTests deploy
