name: Build and Publish JRE Runtime

on:
  push:
    tags:
      - 'v*'   # Trigger on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      java_version:
        description: 'Java version (e.g., 21.0.5+11)'
        required: false
        default: '21.0.5+11'
        type: string
      tag_version:
        description: 'Version tag for the runtime (e.g., 1.0.0)'
        required: false
        default: '1.0.0-manual'
        type: string

permissions:
  contents: write  # Required for creating releases and uploading assets
  packages: write  # Required for publishing to GitHub Packages

jobs:
  build-runtime:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          # Define OS-specific variables for naming
          - os: ubuntu-latest
            os_name: linux
            archive_ext: tar.gz
          - os: macos-latest
            os_name: macos
            archive_ext: tar.gz
          - os: windows-latest
            os_name: windows
            archive_ext: zip

    steps:
      # 1. Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Set Java and version parameters
      - name: Set Java and version parameters
        shell: bash
        run: |
          # Set Java version (from input or default)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            JAVA_VERSION="${{ inputs.java_version }}"
            VERSION="${{ inputs.tag_version }}"
          else
            JAVA_VERSION="21.0.5+11"
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "JAVA_VERSION=$JAVA_VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using Java version: $JAVA_VERSION"
          echo "Using runtime version: $VERSION"

      # 3. Detect architecture
      - name: Detect architecture
        shell: bash
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            ARCH="x64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            ARCH="aarch64"
          fi
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          echo "Detected architecture: $ARCH"

      # 4. Set up JDK 21 using actions/setup-java with JavaFX support
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: liberica
          java-version: 21
          java-package: jdk+fx

      # 5. Verify JAVA_HOME and add to PATH
      - name: Verify JAVA_HOME and add to PATH
        shell: bash
        run: |
          echo "JAVA_HOME before detection: $JAVA_HOME"
          # Try to detect JAVA_HOME if not already set
          if [ -z "$JAVA_HOME" ]; then
            # macOS helper
            if [ -x "/usr/libexec/java_home" ]; then
              JAVA_HOME=$(/usr/libexec/java_home) || true
            fi
          fi
          
          # Fallback: derive from `java` on PATH (Linux/Windows via msys/WSL may differ)
          if [ -z "$JAVA_HOME" ]; then
            if command -v java >/dev/null 2>&1; then
              JAVA_BIN=$(command -v java)
              # resolve symlink if readlink -f is available
              if command -v readlink >/dev/null 2>&1 && readlink -f "$JAVA_BIN" >/dev/null 2>&1; then
                REAL_JAVA_BIN=$(readlink -f "$JAVA_BIN")
              else
                REAL_JAVA_BIN="$JAVA_BIN"
              fi
              JAVA_HOME=$(dirname "$(dirname "$REAL_JAVA_BIN")")
            fi
          fi
          
          if [ -z "$JAVA_HOME" ]; then
            echo "ERROR: JAVA_HOME is not set"
            exit 1
          fi
          
          if [ ! -d "$JAVA_HOME/bin" ]; then
            echo "ERROR: $JAVA_HOME/bin not found"
            echo "Contents of $JAVA_HOME:" || true
            ls -la "$JAVA_HOME" || true
            exit 1
          fi
          
          echo "$JAVA_HOME/bin" >> $GITHUB_PATH
          java -version
          javac -version || true
          jlink --version || true

      # 6. Create custom JRE runtime using jlink
      #    This creates a minimal runtime with JavaFX modules included
      - name: Build custom JRE with jlink (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          # Ensure a clean output directory
          rm -rf build/runtime

          # Run jlink to create custom runtime
          "$JAVA_HOME/bin/jlink" \
            --module-path "$JAVA_HOME/jmods" \
            --add-modules java.base,java.logging,java.desktop,java.sql,java.naming,java.management,java.xml,java.prefs,javafx.controls,javafx.fxml,javafx.graphics,javafx.swing,javafx.media \
            --output build/runtime \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2

          echo "Custom JRE created successfully"
          ls -la build/runtime

      - name: Build custom JRE with jlink (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Ensure a clean output directory on Windows
          if (Test-Path 'build/runtime') { Remove-Item 'build/runtime' -Recurse -Force }

          # Run jlink using Windows paths
          & "$env:JAVA_HOME\bin\jlink.exe" `
            --module-path "$env:JAVA_HOME\jmods" `
            --add-modules java.base,java.logging,java.desktop,java.sql,java.naming,java.management,java.xml,java.prefs,javafx.controls,javafx.fxml,javafx.graphics,javafx.swing,javafx.media `
            --output build/runtime `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2

          Write-Output "Custom JRE created successfully"
          Get-ChildItem build\runtime -Force | Format-List

      # 7. Create archive name based on OS, architecture, and version
      - name: Set archive name
        shell: bash
        run: |
          ARCHIVE_NAME="efa-jre-${{ env.VERSION }}-${{ matrix.os_name }}-${{ env.ARCH }}.${{ matrix.archive_ext }}"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "Archive will be named: $ARCHIVE_NAME"

      # 8. Archive the runtime (tar.gz for Linux/macOS, zip for Windows)
      - name: Archive runtime (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cd build
          tar -czf "../${{ env.ARCHIVE_NAME }}" runtime
          cd ..
          echo "Archive created: ${{ env.ARCHIVE_NAME }}"
          ls -lh "${{ env.ARCHIVE_NAME }}"

      - name: Archive runtime (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd build
          Compress-Archive -Path runtime -DestinationPath "..\${{ env.ARCHIVE_NAME }}"
          cd ..
          echo "Archive created: ${{ env.ARCHIVE_NAME }}"
          Get-Item "${{ env.ARCHIVE_NAME }}" | Format-List

      # 9. Generate SHA-256 checksum for the archive
      - name: Generate SHA-256 checksum
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            sha256sum "${{ env.ARCHIVE_NAME }}" > "${{ env.ARCHIVE_NAME }}.sha256"
          else
            shasum -a 256 "${{ env.ARCHIVE_NAME }}" > "${{ env.ARCHIVE_NAME }}.sha256"
          fi
          cat "${{ env.ARCHIVE_NAME }}.sha256"

      # 10. Upload artifact to GitHub Actions (for workflow verification)
      - name: Upload runtime archive as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jre-${{ matrix.os_name }}-${{ env.ARCH }}
          path: |
            ${{ env.ARCHIVE_NAME }}
            ${{ env.ARCHIVE_NAME }}.sha256

      # 11. Set up Maven for GitHub Packages
      - name: Set up Maven for GitHub Packages
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          server-id: github
          settings-path: ${{ github.workspace }}

      # 12. Publish JRE as GitHub Package (Maven)
      - name: Publish JRE as GitHub Package (Maven)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_GROUP_ID="io.github.dgloeckner.efa"
          PACKAGE_ARTIFACT_ID="${GITHUB_REPOSITORY#*/}-jre"
          PACKAGE_VERSION="${{ env.VERSION }}"
          
          # Determine packaging type based on file extension
          if [[ "${{ env.ARCHIVE_NAME }}" == *.tar.gz ]]; then
            PACKAGING="tar.gz"
          elif [[ "${{ env.ARCHIVE_NAME }}" == *.zip ]]; then
            PACKAGING="zip"
          else
            PACKAGING="jar"
          fi

          echo "Publishing Maven package:"
          echo "  GAV: ${PACKAGE_GROUP_ID}:${PACKAGE_ARTIFACT_ID}:${PACKAGE_VERSION}"
          echo "  File: ${{ env.ARCHIVE_NAME }}"
          echo "  Packaging: ${PACKAGING}"
          echo "  Classifier: ${{ matrix.os_name }}-${{ env.ARCH }}"

          mvn --batch-mode deploy:deploy-file \
            -Dfile="${{ env.ARCHIVE_NAME }}" \
            -DgroupId="${PACKAGE_GROUP_ID}" \
            -DartifactId="${PACKAGE_ARTIFACT_ID}" \
            -Dversion="${PACKAGE_VERSION}" \
            -Dpackaging="${PACKAGING}" \
            -Dclassifier="${{ matrix.os_name }}-${{ env.ARCH }}" \
            -DrepositoryId=github \
            -Durl="https://maven.pkg.github.com/${{ github.repository }}" \
            -s ${{ github.workspace }}/settings.xml

      # 13. Add download instructions as a comment
      - name: Display download instructions
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          # Compute the artifact ID (strip owner prefix)
          PACKAGE_ARTIFACT_ID="${GITHUB_REPOSITORY#*/}-jre"
          
          cat << EOF

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“¦ JRE Runtime Package Published Successfully to GitHub Packages!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          To consume the runtime packages via Maven, add this configuration:

          1ï¸âƒ£  Maven pom.xml configuration:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          <repositories>
            <repository>
              <id>github</id>
              <url>https://maven.pkg.github.com/${{ github.repository }}</url>
            </repository>
          </repositories>

          <dependency>
            <groupId>io.github.dgloeckner.efa</groupId>
            <artifactId>${PACKAGE_ARTIFACT_ID}</artifactId>
            <version>${{ env.VERSION }}</version>
            <classifier>linux-x64</classifier> <!-- or macos-x64, macos-aarch64, windows-x64 -->
            <type>tar.gz</type> <!-- or zip for Windows -->
          </dependency>

          2ï¸âƒ£  Gradle build.gradle configuration:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          repositories {
              maven {
                  url = uri("https://maven.pkg.github.com/${{ github.repository }}")
                  credentials {
                      username = project.findProperty("gpr.user") ?: System.getenv("USERNAME")
                      password = project.findProperty("gpr.key") ?: System.getenv("TOKEN")
                  }
              }
          }

          dependencies {
              implementation("io.github.dgloeckner.efa:${PACKAGE_ARTIFACT_ID}:${{ env.VERSION }}:linux-x64@tar.gz")
          }

          3ï¸âƒ£  Authentication (required for GitHub Packages):
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Add to ~/.m2/settings.xml:

          <servers>
            <server>
              <id>github</id>
              <username>YOUR_GITHUB_USERNAME</username>
              <password>YOUR_GITHUB_TOKEN</password>
            </server>
          </servers>

          Available classifiers:
            â€¢ linux-x64 (tar.gz)
            â€¢ macos-x64 (tar.gz)
            â€¢ macos-aarch64 (tar.gz)
            â€¢ windows-x64 (zip)

          Each package includes JavaFX support and a minimal JRE runtime.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          EOF
